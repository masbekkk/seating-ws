<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dynamic Socket.io Channels</title>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <h1>Dynamic WebSocket Events</h1>
    <input type="text" id="eventInput" placeholder="Enter event name">
    <button onclick="subscribeToEvent()">Subscribe</button>

    <input type="text" id="messageInput" placeholder="Enter message">
    <button onclick="publishMessage()">Publish</button>

    <ul id="messages"></ul>

    <script>
        const SOCKET_URL = window.location.hostname === "localhost"
            ? "http://localhost:3000"
            : "https://seating-ws.taulink.id";

        const API_URL = window.location.hostname === "localhost"
            ? "http://127.0.0.1:8000/api/set-cookie"
            : "https://your-laravel-api.com/api/set-cookie";

        // Function to get session cookie from Laravel
        async function getSessionCookie() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    // credentials: "include",
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error("Failed to get session cookie");
                }

                const data = await response.json();
                console.log("Session Cookie Set:", data.message);

                // Now connect to Socket.IO after session cookie is set
                initializeSocket();
            } catch (error) {
                console.error("Error fetching session:", error);
            }
        }

        function initializeSocket() {
            const socket = io(SOCKET_URL, {
                withCredentials: true, 
                extraHeaders: {
                    "X-SESSION-ID": document.cookie  // Include session cookie
                }
            });
            console.log(socket)
            socket.on("connect", () => {
                console.log("Connected to Socket.IO", socket.id);
            });

            socket.on("message", (msg) => {
                displayMessage(msg);
            });

            window.socket = socket;
        }

        function subscribeToEvent() {
            const eventName = document.getElementById("eventInput").value.trim();
            if (eventName && window.socket) {
                window.socket.emit("subscribe", eventName);
                window.socket.on(eventName, (data) => {
                    displayMessage(`[${eventName}] ${JSON.stringify(data)}`);
                });
                console.log(`Subscribed to ${eventName}`);
            }
        }

        function publishMessage() {
            const eventName = document.getElementById("eventInput").value.trim();
            const message = document.getElementById("messageInput").value.trim();
            if (eventName && message && window.socket) {
                window.socket.emit("publish", { eventName, data: { message } });
                console.log(`Published to ${eventName}: ${message}`);
            }
        }

        function displayMessage(msg) {
            const messagesList = document.getElementById("messages");
            const listItem = document.createElement("li");
            listItem.textContent = msg;
            messagesList.appendChild(listItem);
        }

        // Fetch session cookie first before connecting to Socket.IO
        getSessionCookie();
    </script>
</body>

</html>